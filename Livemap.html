<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HPCL Live Delivery Tracker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      overflow: hidden;
      font-family: "Segoe UI", Roboto, sans-serif;
    }

    body {
      display: flex;
      background: #fff;
    }

    #sidebar {
      width: 360px;
      background: #ffffff;
      border-right: 1px solid #e0e0e0;
      padding: 20px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.05);
      height: 100vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    #sidebar h2 {
      font-size: 20px;
      font-weight: 600;
      color: #004494;
      margin-bottom: 5px;
    }

    label {
      font-weight: 600;
      font-size: 13px;
      margin-top: 5px;
      display: block;
    }

    select, button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-top: 5px;
      margin-bottom: 5px;
      background: #fff;
    }

    button {
      background-color: #0056b3;
      color: white;
      border: none;
      cursor: pointer;
    }

    #map {
      flex: 1;
      height: 100vh;
    }

    .checkbox-group {
      background: #f9fafb;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      max-height: 150px;
      overflow-y: auto;
    }

    .tab-container {
      display: flex;
      gap: 6px;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      background: #e9ecef;
      cursor: pointer;
      font-weight: 600;
    }

    .tab.active {
      background: #0056b3;
      color: #fff;
    }

    .tab-content {
      display: none;
      flex: 1;
    }

    .tab-content.active {
      display: block;
    }

    #successPopup {
      position: fixed;
      top: 50%; left: 50%;
      padding: 16px 28px;
      transform: translate(-50%, -50%) scale(0.8);
      background: #e7f9ec;
      color: #256029;
      border-radius: 12px;
      opacity: 0;
      transition: 0.4s;
      pointer-events: none;
      z-index: 9999;
    }

    #successPopup.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  </style>
</head>

<body>

  <div id="sidebar">
    <h2>HPCL Live Tracker</h2>
    <p><strong>Origin:</strong> Haldia Petrochemicals, WB</p>

    <div class="tab-container">
      <div class="tab active" data-tab="tracking">üì¶ Tracking</div>
      <div class="tab" data-tab="history">üìã Delivery History</div>
    </div>

    <!-- Tracking Tab -->
    <div id="tracking" class="tab-content active">
      <label>Choose Stock Point:</label>
      <select id="stockSelect"></select>

      <label>Select Region:</label>
      <select id="regionSelect">
        <option value="North">North</option>
        <option value="West">West</option>
        <option value="East">East</option>
        <option value="South">South</option>
      </select>

      <label>Select Delivery Locations:</label>
      <div id="checkboxContainer" class="checkbox-group"></div>

      <button id="showDeliveriesBtn">üöõ Show Deliveries</button>
      <div id="railDistance">üìè Rail Route Distance: ‚Äî</div>
      <button id="resetBtn">üîÑ Reset Map</button>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Distance</th>
            <th>Duration</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="deliveryTableBody"></tbody>
      </table>
      <button id="clearAllBtn">üßπ Clear All</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="successPopup">‚úÖ Completed Successfully!</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* ---------------------------------------------------------
       FIXED: API CALLS NOW MATCH BACKEND EXACT ROUTES
    --------------------------------------------------------- */

    const regionDeliveries = {
      North: ["Alwar","Bareilly City","Baddi","Chandigarh","Gurugram","Hapur","Haridwar","Hoshiarpur","Jalandhar","Jammu","Kanpur","Kashipur","Loni, Gaziabad","Lucknow","Saharanpur","Solan","Yamunanagar","Azadpur"],
      West: ["Ahmedabad","Ankleshwar","Dahej","Dombivli","Kandla, Gujarat","Khopoli","Lote","Mahad","Pune","Rajkot","Sabarkantha","Surat","Tarapur, Maharashtra","Vadodara","Valsad, Gujarat","Vapi, Gujarat"],
      East: [],
      South: []
    };

    function showSuccessPopup() {
      const p = document.getElementById("successPopup");
      p.classList.add("show");
      setTimeout(() => p.classList.remove("show"), 2000);
    }

    const map = L.map("map").setView([20.5937, 78.9629], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    const origin = [22.0667, 88.1145];

    const haldiaMarker = L.marker(origin, {
      icon: L.divIcon({
        className: "custom-marker",
        html: `<div style="width:18px;height:18px;background-color:#d9534f;border-radius:50%;border:2px solid white"></div>`
      })
    }).addTo(map);

    const stockSelect = document.getElementById("stockSelect");
    const regionSelect = document.getElementById("regionSelect");
    const checkboxContainer = document.getElementById("checkboxContainer");
    const showDeliveriesBtn = document.getElementById("showDeliveriesBtn");
    const railDistanceDiv = document.getElementById("railDistance");
    const deliveryTableBody = document.getElementById("deliveryTableBody");
    const clearAllBtn = document.getElementById("clearAllBtn");

    let stockData = {};
    let currentStock = null;
    let deliveryMap = {};
    let railRouteLine = null;
    let stockMarker = null;

    async function loadRoutes() {
      const res = await fetch("/routes");   // ‚úÖ FIXED
      stockData = await res.json();
      Object.keys(stockData).forEach(key => {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = stockData[key].name;
        stockSelect.appendChild(opt);
      });
      setStockPoint(Object.keys(stockData)[0]);
    }

    function createFixedMarker(color = "#228B22") {
      return L.divIcon({
        className: "custom-marker",
        html: `<div style="width:18px;height:18px;background:${color};border-radius:50%;border:2px solid #fff"></div>`
      });
    }

    function drawRailRoute(stockKey) {
      if (railRouteLine) map.removeLayer(railRouteLine);
      const coords = stockData[stockKey].route;
      if (!coords) return;

      let dist = 0;
      for (let i = 1; i < coords.length; i++) {
        dist += map.distance(coords[i - 1], coords[i]);
      }
      railDistanceDiv.innerHTML = `üìè Rail Route Distance: ${(dist / 1000).toFixed(1)} km`;

      railRouteLine = L.polyline(coords, { color: "green", dashArray: "5,5", weight: 3 }).addTo(map);
    }

    function setStockPoint(key) {
      currentStock = stockData[key];

      if (stockMarker) map.removeLayer(stockMarker);

      stockMarker = L.marker(currentStock.coords, {
        icon: createFixedMarker("#228B22")
      }).addTo(map);

      map.setView(currentStock.coords, 7);
      drawRailRoute(key);
    }

    stockSelect.addEventListener("change", e => setStockPoint(e.target.value));

    function populateLocations(region) {
      checkboxContainer.innerHTML = "";

      const selectAll = document.createElement("label");
      selectAll.innerHTML = `<input type="checkbox" id="selectAll"> Select All`;
      checkboxContainer.appendChild(selectAll);

      regionDeliveries[region].forEach(city => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${city}"> ${city}`;
        checkboxContainer.appendChild(label);
      });

      document.getElementById("selectAll").addEventListener("change", e => {
        checkboxContainer.querySelectorAll("input[type='checkbox']:not(#selectAll)").forEach(
          cb => cb.checked = e.target.checked
        );
      });
    }

    regionSelect.addEventListener("change", e => populateLocations(e.target.value));

    async function getCoordinates(city) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&countrycodes=in&limit=1`);
      const data = await res.json();
      if (!data.length) return null;
      return [parseFloat(data[0].lat), parseFloat(data[0].lon), data[0].display_name];
    }

    async function addDelivery(city) {
      const coords = await getCoordinates(city);
      if (!coords) return;

      const [lat, lon, name] = coords;

      const url = `/route?start_lat=${currentStock.coords[0]}&start_lng=${currentStock.coords[1]}&end_lat=${lat}&end_lng=${lon}`;

      const res = await fetch(url);   // ‚úÖ FIXED
      const data = await res.json();

      if (!data.features) return;

      const routeCoords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      const distance = (data.features[0].properties.segments[0].distance / 1000).toFixed(2);
      const duration = data.features[0].properties.segments[0].duration / 3600;
      const time = `${Math.floor(duration)}h ${Math.round((duration % 1) * 60)}m`;

      const routeLine = L.polyline(routeCoords, { color: "blue", weight: 3 }).addTo(map);
      const destMarker = L.marker([lat, lon], { icon: createFixedMarker("#007bff") })
        .bindPopup(`<b>${name}</b><br>${distance} km<br>${time}`)
        .addTo(map);

      // Add to table
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${currentStock.name}</td>
        <td>${city}</td>
        <td>${distance} km</td>
        <td>${time}</td>
        <td>‚úÖ OK</td>
        <td><button class="remove-btn">X</button></td>
      `;
      deliveryTableBody.prepend(row);

      row.querySelector(".remove-btn").addEventListener("click", () => {
        map.removeLayer(routeLine);
        map.removeLayer(destMarker);
        row.remove();
      });
    }

    showDeliveriesBtn.addEventListener("click", async () => {
      const selected = [...checkboxContainer.querySelectorAll("input[type='checkbox']:checked:not(#selectAll)")]
        .map(c => c.value);

      if (!selected.length) return alert("Please select at least one location.");

      for (let i = 0; i < selected.length; i++) {
        await addDelivery(selected[i]);
      }

      showSuccessPopup();
    });

    clearAllBtn.addEventListener("click", () => {
      deliveryTableBody.innerHTML = "";
      Object.values(deliveryMap).forEach(d => {
        if (d.routeLine) map.removeLayer(d.routeLine);
        if (d.destMarker) map.removeLayer(d.destMarker);
      });
    });

    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    populateLocations("North");
    loadRoutes();
  </script>
</body>
</html>
