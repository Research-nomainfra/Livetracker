<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Noma IntelliRoute Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    :root {
      --accent:#0056b3;
      --accent-dark:#003d82;
      --muted:#6b7280;
      --bg:#f4f6fa;
      --card:#ffffff;
      --radius:12px;
    }

    html,body {
      height:100%; margin:0;
      font-family:Inter, "Segoe UI", Roboto, Arial;
      background:var(--bg);
      color:#0f172a;
    }

    body { display:flex; overflow:hidden; }

    /* SIDEBAR */
    #sidebar {
      width:380px;
      min-width:330px;
      max-width:420px;
      background:#fff;
      padding:20px;
      box-sizing:border-box;
      height:100vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:14px;
      border-right:1px solid rgba(0,0,0,0.08);
      box-shadow:6px 0 20px rgba(0,0,0,0.06);
    }

    /* ---------- NEW HEADER BLOCK (OPTION B) ---------- */
    .header-card {
      background:#ffffff;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.06);
      padding:16px;
      display:flex;
      align-items:center;
      gap:14px;
      width:100%;
      box-sizing:border-box;
    }

    .header-card img {
      width:90px;
      height:auto;
      object-fit:contain;
    }

    .header-text {
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:2px;
    }

    .header-text h1 {
      font-size:18px;
      margin:0;
      font-weight:700;
      color:#003d82;
      line-height:1.2;
    }

    .header-sub {
      text-align:center;
      width:100%;
      margin:6px 0 2px 0;
      font-size:13px;
      color:#475569;
      font-weight:500;
    }

    .tab-container {
      display:flex;
      gap:10px;
      margin-top:6px;
    }

    .tab {
      flex:1;
      padding:10px 14px;
      border-radius:10px;
      background:#eef1f5;
      cursor:pointer;
      border:1px solid #dfe5ec;
      font-size:14px;
      font-weight:600;
      text-align:center;
      transition:0.2s;
    }
    .tab.active { background:#0056b3; color:#fff; }

    .content {
      flex:1;
      overflow:auto;
      padding-right:6px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .section {
      background:#fff;
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.06);
    }

    label {
      font-size:13px;
      font-weight:700;
      margin-bottom:6px;
    }

    select,input,button {
      font-size:14px;
      border-radius:8px;
      padding:10px;
      border:1px solid #d7dce3;
      background:#fff;
    }

    /* DELIVERY GRID */
    .checkbox-group {
      border:1px solid #dce3eb;
      border-radius:10px;
      padding:10px;
      background:#fafcff;
      max-height:150px;
      overflow:auto;
    }

    .checkbox-grid {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .checkbox-grid label {
      display:flex;
      align-items:center;
      gap:6px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.06);
      border-radius:8px;
      padding:6px;
      min-width:calc(50% - 8px);
      font-size:13px;
      cursor:pointer;
    }

    /* Manual row */
    .manual-row {
      display:flex; gap:8px;
    }
    .manual-row input { flex:1; }
    .manual-row button {
      width:110px;
      background:#0056b3;
      color:#fff;
      border:none;
      cursor:pointer;
    }

    /* History Table */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td {
      padding:8px;
      border-bottom:1px solid #e6eaf0;
    }
    th { background:#f8fafc; font-weight:700; }

    .remove-btn {
      background:#e63939;
      color:#fff;
      border:none;
      padding:5px 8px;
      border-radius:6px;
      cursor:pointer;
    }

    /* Success popup */
    #successPopup {
      position:fixed;
      top:16px;
      right:16px;
      background:#e7f9ec;
      color:#127a29;
      padding:10px 16px;
      border-radius:10px;
      opacity:0;
      transform:translateY(-10px);
      transition:0.2s;
      z-index:2000;
      font-weight:600;
    }
    #successPopup.show { opacity:1; transform:translateY(0); }

    /* Loading overlay */
    #loadingOverlay {
      position:fixed;
      inset:0;
      background:rgba(255,255,255,0.85);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:3000;
    }
    .loader {
      width:50px; height:50px;
      border:5px solid #dce3ef;
      border-top-color:#0056b3;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }
    #loadingText { margin-top:10px; color:#003d82; font-weight:600; }

    #map { flex:1; height:100vh; }

    /* Mobile responsive */
    @media(max-width:900px){
      #sidebar { width:100%; max-width:none; height:auto; position:relative; }
      body { flex-direction:column; }
      #map { height:70vh; }
      .header-card img { width:70px; }
      .header-text h1 { font-size:16px; }
    }
  </style>
</head>

<body>

<div id="sidebar">

  <!-- NEW HEADER BLOCK (logo + title inside card) -->
  <div class="header-card">
    <img src="Noma Logo (Registered).png" alt="NOMA Logo">

    <div class="header-text">
      <h1>NOMA IntelliRoute<br>Console</h1>
    </div>
  </div>

  <!-- Subtitle OUTSIDE the card -->
  <div class="header-sub">
    Intelligent Route Planning & Delivery Mapping
  </div>

  <!-- TABS -->
  <div class="tab-container">
    <div class="tab active" data-tab="tracking">üì¶ Tracking</div>
    <div class="tab" data-tab="history">üìã History</div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="content">

    <!-- TRACKING TAB -->
    <div id="tracking" class="section tab-content active">

      <label>Choose Stock Point</label>
      <select id="stockSelect"></select>

      <label style="margin-top:10px;">Select Region</label>
      <select id="regionSelect">
        <option value="North">North</option>
        <option value="West">West</option>
        <option value="East">East</option>
        <option value="South">South</option>
      </select>

      <label style="margin-top:10px;">Select Delivery Locations</label>
      <div class="checkbox-group">
        <div class="checkbox-grid" id="checkboxGrid"></div>
      </div>

      <label style="margin-top:10px;">üîç Search Any Location</label>
      <div class="manual-row">
        <input id="manualInput" type="text" placeholder="Enter city or address">
        <button id="manualAddBtn">Add</button>
      </div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button id="showDeliveriesBtn" style="flex:1; background:#0056b3; color:#fff;">Show</button>
        <button id="resetBtn" style="flex:1;">Reset</button>
      </div>

      <div id="railDistance" style="font-size:13px; margin-top:8px; color:#556;"></div>

    </div>

    <!-- HISTORY TAB -->
    <div id="history" class="section tab-content" style="display:none;">
      <table>
        <thead>
          <tr><th>From</th><th>To</th><th>Distance</th><th>Duration</th><th>Status</th><th></th></tr>
        </thead>
        <tbody id="deliveryTableBody"></tbody>
      </table>
      <button id="clearAllBtn" style="margin-top:10px; width:100%;">Clear All</button>
    </div>

  </div>
</div>

  <!-- MAP -->
  <div id="map" role="region" aria-label="Map"></div>

  <!-- success + loading overlays -->
  <div id="successPopup" aria-live="polite"></div>
  <div id="loadingOverlay" aria-hidden="true">
    <div class="loader" role="status" aria-label="Loading"></div>
    <div id="loadingText">Loading... 0s</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  /* ============================
     App: combined final HTML + JS
     Features implemented:
     - Logo banner with side insets (10% left/right)
     - Logo fixed 120px
     - Delivery UI grid (A) with reduced height & scroll
     - Uncheck behavior: remove route when checkbox is unchecked (Both)
     - Multiple same delivery allowed across different stock points (stock|city unique)
     - Route highlight without removing markers (keeps markers visible)
     - Manual search add
     - Responsive for mobile (sidebar top)
  ============================ */

  const regionDeliveries = {
    North: ["Alwar","Bareilly City","Baddi","Chandigarh","Gurugram","Hapur","Haridwar","Hoshiarpur","Jalandhar","Jammu","Kanpur","Kashipur","Loni, Gaziabad","Lucknow","Saharanpur","Solan","Yamunanagar","Azadpur"],
    West: ["Ahmedabad","Ankleshwar","Dahej","Dombivli","Kandla, Gujarat","Khopoli","Lote","Mahad","Pune","Rajkot","Sabarkantha","Surat","Tarapur, Maharashtra","Vadodara","Valsad, Gujarat","Vapi, Gujarat"],
    East: [], South: []
  };

  // DOM
  const stockSelect = document.getElementById('stockSelect');
  const regionSelect = document.getElementById('regionSelect');
  const checkboxGrid = document.getElementById('checkboxGrid');
  const manualInput = document.getElementById('manualInput');
  const manualAddBtn = document.getElementById('manualAddBtn');
  const showDeliveriesBtn = document.getElementById('showDeliveriesBtn');
  const resetBtn = document.getElementById('resetBtn');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const deliveryTableBody = document.getElementById('deliveryTableBody');
  const railDistanceDiv = document.getElementById('railDistance');
  const successPopup = document.getElementById('successPopup');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');

  // map init
  const map = L.map('map').setView([20.5937,78.9629],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  function markerIcon(color){
    return L.divIcon({
      className:'custom-marker',
      html:`<div style="width:18px;height:18px;background:${color};border-radius:50%;border:2px solid #fff;box-shadow:0 2px 6px rgba(10,20,40,0.12)"></div>`,
      iconSize:[18,18],iconAnchor:[9,9]
    });
  }

  const origin = [22.0667,88.1145];
  L.marker(origin,{icon:markerIcon('#d9534f')}).addTo(map).bindPopup('Haldia Petrochemicals, WB');

  // state
  let stockData = {};
  let currentStock = null;
  let stockMarker = null;
  let railRouteLine = null;
  let deliveryLayers = {}; // key=stockKey|city -> {line, marker, row}
  let addedDeliveries = new Set(); // stockKey|city

  // loading helpers
  function showLoading(){ loadingOverlay.style.display = 'flex'; loadingOverlay.setAttribute('aria-hidden','false'); }
  function hideLoading(){ loadingOverlay.style.display = 'none'; loadingOverlay.setAttribute('aria-hidden','true'); }
  function showSuccess(text='Completed'){ successPopup.textContent = '‚úÖ ' + text; successPopup.classList.add('show'); setTimeout(()=>successPopup.classList.remove('show'),2000); }

  // load routes (backend /routes)
  async function loadRoutes(){
    try{
      const r = await fetch('/routes');
      stockData = await r.json();
      stockSelect.innerHTML = '';
      Object.keys(stockData).forEach(key=>{
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = stockData[key].name;
        stockSelect.appendChild(opt);
      });
      const first = Object.keys(stockData)[0];
      if(first) setStockPoint(first);
    }catch(err){
      console.error('Failed load routes', err);
      alert('Failed to load Routes.json');
    }
  }

  function setStockPoint(key){
    if(!stockData[key]) return;
    currentStock = stockData[key];
    if(stockMarker) map.removeLayer(stockMarker);
    stockMarker = L.marker(currentStock.coords,{icon:markerIcon('#228B22')}).addTo(map).bindPopup(currentStock.name);
    map.setView(currentStock.coords,7);
    drawRailRoute(key);
  }
  stockSelect.addEventListener('change', e => setStockPoint(e.target.value));

  function drawRailRoute(key){
    if(railRouteLine) map.removeLayer(railRouteLine);
    const route = stockData[key]?.route;
    if(!route){ railDistanceDiv.innerHTML = 'üìè Rail Route Distance: ‚Äî'; return; }
    let total=0;
    for(let i=1;i<route.length;i++) total += map.distance(route[i-1], route[i]);
    railDistanceDiv.innerHTML = `üìè Rail Route Distance: ${(total/1000).toFixed(1)} km`;
    railRouteLine = L.polyline(route,{color:'#1b9b53',dashArray:'6,6',weight:3}).addTo(map);
  }

  // populate checkboxes (grid A). Reduced height & scroll handled by CSS
  function populateLocations(region){
    checkboxGrid.innerHTML = '';
    // select-all label spanning full width
    const topLabel = document.createElement('label');
    topLabel.style.minWidth = '100%';
    topLabel.style.border = 'none';
    topLabel.innerHTML = `<input type="checkbox" id="selectAll"> <strong style="margin-left:8px">Select All</strong>`;
    checkboxGrid.appendChild(topLabel);

    regionDeliveries[region].forEach(city=>{
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="checkbox" value="${city}"> <span style="flex:1">${city}</span>`;
      checkboxGrid.appendChild(lab);
    });

    const selAll = document.getElementById('selectAll');
    if(selAll){
      selAll.addEventListener('change', e=>{
        checkboxGrid.querySelectorAll('input[type="checkbox"]:not(#selectAll)').forEach(cb=>{
          // if checking -> add route; if unchecking -> remove route
          if(e.target.checked && !cb.checked){
            cb.checked = true;
            cb.dispatchEvent(new Event('change', { bubbles:true }));
          } else if(!e.target.checked && cb.checked){
            cb.checked = false;
            cb.dispatchEvent(new Event('change', { bubbles:true }));
          } else {
            cb.checked = e.target.checked;
            cb.dispatchEvent(new Event('change', { bubbles:true }));
          }
        });
      });
    }

    // attach change handler per checkbox to add/remove on toggle
    checkboxGrid.querySelectorAll('input[type="checkbox"]:not(#selectAll)').forEach(cb=>{
      cb.addEventListener('change', async (ev)=>{
        const city = ev.target.value;
        if(ev.target.checked){
          await addDelivery(city);
        } else {
          removeDeliveryByCheckbox(city);
        }
      });
    });
  }

  regionSelect.addEventListener('change', e => populateLocations(e.target.value));

  // backend geocode proxy
  async function geocodeORS(city){
    try{
      const r = await fetch(`/geocode?query=${encodeURIComponent(city)}`);
      if(!r.ok) return null;
      const j = await r.json();
      if(!j.features || !j.features.length) return null;
      const f = j.features[0];
      return [ f.geometry.coordinates[1], f.geometry.coordinates[0], f.properties.label || city ];
    }catch(e){
      console.error('geocode error', e);
      return null;
    }
  }

  // addDelivery: prevents duplicates for same stock; allows same city on different stock
  async function addDelivery(city){
    if(!currentStock){ alert('Select a stock point first'); return; }
    const stockKey = stockSelect.value;
    const uniqueKey = `${stockKey}|${city}`;

    if(addedDeliveries.has(uniqueKey)){
      console.log('Already added for this stock:', uniqueKey);
      return;
    }

    // geocode
    showLoading();
    const geo = await geocodeORS(city);
    hideLoading();
    if(!geo){ alert('Could not geocode: ' + city); return; }
    const [lat, lon, label] = geo;

    // route call
    const url = `/route?start_lat=${currentStock.coords[0]}&start_lng=${currentStock.coords[1]}&end_lat=${lat}&end_lng=${lon}`;
    showLoading();
    let routeJson;
    try{
      const r = await fetch(url);
      if(!r.ok){ throw new Error('Route request failed ' + r.status); }
      routeJson = await r.json();
    }catch(err){
      console.error('route error', err);
      hideLoading();
      return alert('Routing failed for ' + city);
    }
    hideLoading();

    if(!routeJson.features || !routeJson.features.length){ alert('No route found for ' + city); return; }

    const coords = routeJson.features[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    const seg = routeJson.features[0].properties.segments[0];
    const dist = (seg.distance/1000).toFixed(2);
    const hrs = Math.floor(seg.duration/3600);
    const mins = Math.round(((seg.duration/3600)-hrs)*60);
    const time = `${hrs}h ${mins}m`;

    // draw
    const line = L.polyline(coords, { color:'#2b6be6', weight:3 }).addTo(map);
    const marker = L.marker([lat,lon], { icon: markerIcon('#007bff') }).addTo(map).bindPopup(`<b>${label}</b><br>${dist} km<br>${time}`);

    // keep markers visually on top using z-index offsets during highlight (no removal of marker icon)
    marker.setZIndexOffset(0);
    if(stockMarker) stockMarker.setZIndexOffset(0);

    // store
    deliveryLayers[uniqueKey] = { line, marker };
    addedDeliveries.add(uniqueKey);

    // add table row & keep mapping
    const row = document.createElement('tr');
    row.innerHTML = `<td style="min-width:140px">${currentStock.name}</td><td>${city}</td><td>${dist} km</td><td>${time}</td><td>‚úî</td><td><button class="remove-btn">√ó</button></td>`;
    deliveryTableBody.prepend(row);

    // attach highlight (bringToFront + scale) ‚Äî markers remain present
    row.addEventListener('mouseenter', ()=>{
      line.setStyle({ color:'#000', weight:6, opacity:0.98 });
      line.bringToFront();
      marker.setZIndexOffset(2000);
      if(marker._icon){ marker._icon.style.transform='scale(1.35)'; marker._icon.style.filter='drop-shadow(0 0 12px rgba(0,0,0,0.6))'; }
      if(stockMarker && stockMarker._icon){ stockMarker.setZIndexOffset(1500); stockMarker._icon.style.transform='scale(1.25)'; stockMarker._icon.style.filter='drop-shadow(0 0 10px rgba(0,0,0,0.35))'; }
    });
    row.addEventListener('mouseleave', ()=>{
      line.setStyle({ color:'#2b6be6', weight:3, opacity:1 });
      marker.setZIndexOffset(0);
      if(marker._icon){ marker._icon.style.transform='scale(1)'; marker._icon.style.filter=''; }
      if(stockMarker && stockMarker._icon){ stockMarker.setZIndexOffset(0); stockMarker._icon.style.transform='scale(1)'; stockMarker._icon.style.filter=''; }
    });

    // remove button handler
    row.querySelector('.remove-btn').addEventListener('click', ()=>{
      removeDelivery(uniqueKey);
      // also uncheck checkbox UI if present
      uncheckCheckboxForCity(city);
      row.remove();
    });

    // if a checkbox for this city exists and is unchecked we should check it (optional UX: sync state)
    // find checkbox and set checked true (but avoid double-adding because addDelivery checks set)
    const cb = checkboxGrid.querySelector(`input[type="checkbox"][value="${CSS.escape(city)}"]`);
    if(cb && !cb.checked){
      cb.checked = true;
    }

    showSuccess(city + ' added');
  }

  // remove delivery by unique key (stockKey|city)
  function removeDelivery(uniqueKey){
    const item = deliveryLayers[uniqueKey];
    if(!item) return;
    if(item.line) map.removeLayer(item.line);
    if(item.marker) map.removeLayer(item.marker);
    delete deliveryLayers[uniqueKey];
    addedDeliveries.delete(uniqueKey);
    // remove row in table if exists
    const rows = Array.from(deliveryTableBody.querySelectorAll('tr'));
    for(const r of rows){
      if(r.cells && r.cells[1] && r.cells[1].textContent.trim()){
        const city = r.cells[1].textContent.trim();
        const stock = r.cells[0].textContent.trim();
        if(`${stockSelect.value}|${city}` === uniqueKey || `${stock}|${city}` === uniqueKey){
          r.remove();
          break;
        }
      }
    }
  }

  // remove when checkbox is unchecked: find the unique key(s) for current stock
  function removeDeliveryByCheckbox(city){
    const stockKey = stockSelect.value;
    const uniqueKey = `${stockKey}|${city}`;
    // ensure we remove only that stock|city
    if(addedDeliveries.has(uniqueKey)){
      removeDelivery(uniqueKey);
    }
  }

  // helper to uncheck checkbox for a city in the UI (used when row removed)
  function uncheckCheckboxForCity(city){
    const cb = checkboxGrid.querySelector(`input[type="checkbox"][value="${CSS.escape(city)}"]`);
    if(cb) cb.checked = false;
  }

  // manual add handlers
  manualAddBtn.addEventListener('click', async ()=>{
    const txt = manualInput.value.trim();
    if(!txt) return alert('Enter a location');
    manualInput.value = '';
    await addDelivery(txt);
  });
  manualInput.addEventListener('keypress', e=>{ if(e.key==='Enter') manualAddBtn.click(); });

  // bulk add selected (sequential with loading & progress)
  async function showSelectedDeliveries(){
    const checked = Array.from(checkboxGrid.querySelectorAll('input[type="checkbox"]:checked:not(#selectAll)')).map(cb=>cb.value);
    if(!checked.length) return alert('Select at least one location');
    showLoading();
    let seconds = 0;
    const t = setInterval(()=>{ seconds++; loadingText.textContent = `Loading... ${seconds}s`; }, 1000);

    for(let i=0;i<checked.length;i++){
      const pct = Math.round(((i+1)/checked.length)*100);
      loadingText.textContent = `Loading ${i+1} of ${checked.length} (${pct}%) ‚Ä¢ ${seconds}s`;
      await addDelivery(checked[i]);
    }

    clearInterval(t);
    hideLoading();
    showSuccess('Deliveries added');
  }
  showDeliveriesBtn.addEventListener('click', showSelectedDeliveries);

  // clear all
  clearAllBtn.addEventListener('click', ()=>{
    Object.values(deliveryLayers).forEach(v=>{ if(v.line) map.removeLayer(v.line); if(v.marker) map.removeLayer(v.marker); });
    deliveryLayers = {};
    addedDeliveries.clear();
    deliveryTableBody.innerHTML = '';
    // uncheck all checkboxes
    checkboxGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = false);
  });

  // reset (clear + reset UI + map view)
  resetBtn.addEventListener('click', ()=>{
    clearAllBtn.click();
    if(railRouteLine){ map.removeLayer(railRouteLine); railRouteLine = null; }
    if(stockMarker){ map.removeLayer(stockMarker); stockMarker = null; }
    railDistanceDiv.innerHTML = 'üìè Rail Route Distance: ‚Äî';
    regionSelect.value = 'North';
    populateLocations('North');
    const first = Object.keys(stockData)[0];
    if(first){ stockSelect.value = first; setStockPoint(first); }
    map.setView([20.5937,78.9629],6);
  });

  // tabs
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
      tab.classList.add('active');
      const id = tab.dataset.tab;
      document.getElementById(id).style.display = 'block';
    });
  });

  // init
  populateLocations('North');
  loadRoutes();

  </script>
</body>
</html>


