<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HPCL Live Delivery Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body { margin:0; padding:0; height:100%; font-family:"Segoe UI",Roboto,sans-serif; }
    body { display:flex; background:#fff; overflow:hidden; }

    #sidebar {
      width:360px; background:#fff; border-right:1px solid #e0e0e0;
      padding:20px; box-shadow:4px 0 10px rgba(0,0,0,0.05);
      height:100vh; overflow-y:auto; display:flex; flex-direction:column; gap:14px;
    }
    #sidebar h2 { font-size:20px; font-weight:600; color:#004494; margin:0 0 4px; }
    label { font-size:13px; font-weight:600; margin-top:6px; display:block; }

    select, button, input {
      width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;
      background:#fff; font-size:14px; margin-top:6px;
    }

    button { background:#0056b3; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#00408a; }

    #map { flex:1; height:100vh; }

    .checkbox-group {
      border:1px solid #ddd; background:#f9fafb; padding:8px;
      border-radius:8px; max-height:150px; overflow-y:auto;
    }

    .tab-container { display:flex; gap:6px; }
    .tab { flex:1; padding:8px; text-align:center; border-radius:8px;
      background:#e9ecef; font-weight:600; cursor:pointer; }
    .tab.active { background:#0056b3; color:#fff; }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { padding:8px; border-bottom:1px solid #ddd; font-size:13px; }
    th { background:#f0f2f5; }

    .remove-btn {
      background:#e74c3c; color:#fff; border:none; padding:4px 8px;
      border-radius:4px; cursor:pointer;
    }

    #successPopup {
      position:fixed; top:50%; left:50%; padding:16px 26px;
      background:#e7f9ec; color:#256029; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transform:translate(-50%, -50%) scale(0.8);
      opacity:0; pointer-events:none; transition:all .35s; z-index:9999;
      font-size:18px; font-weight:600;
    }
    #successPopup.show { opacity:1; transform:translate(-50%, -50%) scale(1); }

    /* LOADING OVERLAY */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.85);
      z-index: 9998;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: "Segoe UI", sans-serif;
    }

    .loader {
      width: 50px;
      height: 50px;
      border: 5px solid #ccc;
      border-top: 5px solid #004494;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }

    #loadingText {
      font-size: 18px;
      color: #004494;
      font-weight: 600;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

  </style>
</head>

<body>

  <div id="sidebar">
    <h2>HPCL Live Tracker</h2>
    <p><strong>Origin:</strong> Haldia Petrochemicals, WB</p>

    <div class="tab-container">
      <div class="tab active" data-tab="tracking">üì¶ Tracking</div>
      <div class="tab" data-tab="history">üìã Delivery History</div>
    </div>

    <div id="tracking" class="tab-content active">

      <!-- STOCK -->
      <label>Choose Stock Point:</label>
      <select id="stockSelect"></select>

      <!-- REGION -->
      <label>Select Region:</label>
      <select id="regionSelect">
        <option value="North">North</option>
        <option value="West">West</option>
        <option value="East">East</option>
        <option value="South">South</option>
      </select>

      <!-- PRESET DELIVERY LOCATIONS -->
      <label>Select Delivery Locations:</label>
      <div id="checkboxContainer" class="checkbox-group"></div>

      <!-- MANUAL SEARCH -->
      <label>üîç Search Any Delivery Location:</label>
      <div style="display:flex; gap:6px;">
        <input id="manualInput" 
               type="text" 
               placeholder="Enter city, area, or location">
        <button id="manualAddBtn" style="width:120px;">Add</button>
      </div>

      <button id="showDeliveriesBtn">üöõ Show Deliveries</button>
      <div id="railDistance">üìè Rail Route Distance: ‚Äî</div>
      <button id="resetBtn">üîÑ Reset Map</button>

    </div>

    <div id="history" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>From</th><th>To</th><th>Distance</th>
            <th>Duration</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="deliveryTableBody"></tbody>
      </table>
      <button id="clearAllBtn">üßπ Clear All</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="successPopup">‚úÖ Completed Successfully!</div>

  <!-- LOADING OVERLAY -->
  <div id="loadingOverlay">
    <div class="loader"></div>
    <div id="loadingText">Loading... 0s</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>

    /*===================================
      REGION DELIVERY LISTS
    ===================================*/
    const regionDeliveries = {
      North: ["Alwar","Bareilly City","Baddi","Chandigarh","Gurugram","Hapur","Haridwar","Hoshiarpur","Jalandhar","Jammu","Kanpur","Kashipur","Loni, Gaziabad","Lucknow","Saharanpur","Solan","Yamunanagar","Azadpur"],
      West: ["Ahmedabad","Ankleshwar","Dahej","Dombivli","Kandla, Gujarat","Khopoli","Lote","Mahad","Pune","Rajkot","Sabarkantha","Surat","Tarapur, Maharashtra","Vadodara","Valsad, Gujarat","Vapi, Gujarat"],
      East: [],
      South: []
    };

    /*===================================
      MAP INITIALIZATION
    ===================================*/
    const map = L.map("map").setView([20.5937, 78.9629], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    function markerIcon(color) {
      return L.divIcon({
        className:"custom-marker",
        html:`<div style="width:18px;height:18px;background:${color};border:2px solid #fff;border-radius:50%"></div>`,
        iconSize:[18,18], iconAnchor:[9,9]
      });
    }

    const origin = [22.0667, 88.1145];
    L.marker(origin, { icon: markerIcon("#d9534f") })
      .addTo(map)
      .bindPopup("Haldia Petrochemicals, WB");

    /*===================================
      DOM ELEMENTS
    ===================================*/
    const stockSelect = document.getElementById("stockSelect");
    const regionSelect = document.getElementById("regionSelect");
    const checkboxContainer = document.getElementById("checkboxContainer");
    const manualInput = document.getElementById("manualInput");
    const manualAddBtn = document.getElementById("manualAddBtn");
    const showDeliveriesBtn = document.getElementById("showDeliveriesBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const resetBtn = document.getElementById("resetBtn");
    const railDistanceDiv = document.getElementById("railDistance");
    const deliveryTableBody = document.getElementById("deliveryTableBody");
    const successPopup = document.getElementById("successPopup");

    /*===================================
      STATE
    ===================================*/
    let stockData = {};
    let currentStock = null;
    let stockMarker = null;
    let railRouteLine = null;

    let deliveryLayers = {};
    let addedDeliveries = new Set(); // UNIQUE: STOCK|CITY

    /*===================================
      LOAD STOCK ROUTES
    ===================================*/
    async function loadRoutes() {
      const res = await fetch("/routes");
      stockData = await res.json();

      stockSelect.innerHTML = "";
      Object.keys(stockData).forEach(key => {
        const opt = document.createElement("option");
        opt.value = key;
        opt.textContent = stockData[key].name;
        stockSelect.appendChild(opt);
      });

      const first = Object.keys(stockData)[0];
      if (first) setStockPoint(first);
    }

    /*===================================
      SET STOCK POINT
    ===================================*/
    function setStockPoint(key) {
      currentStock = stockData[key];

      if (stockMarker) map.removeLayer(stockMarker);

      stockMarker = L.marker(currentStock.coords, { icon: markerIcon("#228B22") })
        .addTo(map)
        .bindPopup(currentStock.name);

      map.setView(currentStock.coords, 7);
      drawRailRoute(key);
    }

    stockSelect.addEventListener("change", e => setStockPoint(e.target.value));

    /*===================================
      DRAW RAIL ROUTE
    ===================================*/
    function drawRailRoute(key) {
      if (railRouteLine) map.removeLayer(railRouteLine);

      const route = stockData[key].route;
      if (!route) return;

      let total = 0;
      for (let i = 1; i < route.length; i++)
        total += map.distance(route[i - 1], route[i]);

      railDistanceDiv.innerHTML = `üìè Rail Route Distance: ${(total/1000).toFixed(1)} km`;

      railRouteLine = L.polyline(route, { color:"green", dashArray:"5,5", weight:3 }).addTo(map);
    }

    /*===================================
      POPULATE LOCATIONS
    ===================================*/
    function populateLocations(region) {
      checkboxContainer.innerHTML = "";

      const all = document.createElement("label");
      all.innerHTML = `<input type="checkbox" id="selectAll"> Select All`;
      checkboxContainer.appendChild(all);

      regionDeliveries[region].forEach(city => {
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${city}"> ${city}`;
        checkboxContainer.appendChild(lbl);
      });

      document.getElementById("selectAll").addEventListener("change", e => {
        checkboxContainer.querySelectorAll("input[type='checkbox']:not(#selectAll)")
          .forEach(cb => cb.checked = e.target.checked);
      });
    }

    regionSelect.addEventListener("change", e => populateLocations(e.target.value));

    /*===================================
      GEOCODE (BACKEND ORS)
    ===================================*/
    async function geocodeORS(city) {
      const res = await fetch(`/geocode?query=${encodeURIComponent(city)}`);
      const data = await res.json();

      if (!data.features || !data.features.length) return null;

      return [
        data.features[0].geometry.coordinates[1],
        data.features[0].geometry.coordinates[0],
        data.features[0].properties.label || city
      ];
    }

    /*===================================
      ADD DELIVERY (MAIN FUNCTION)
    ===================================*/
    async function addDelivery(city) {
      const uniqueKey = `${stockSelect.value}|${city}`;

      // Prevent duplicate on same stock
      if (addedDeliveries.has(uniqueKey)) {
        console.log("Duplicate skipped:", uniqueKey);
        return;
      }

      const geo = await geocodeORS(city);
      if (!geo) return alert("Invalid or unrecognized location: " + city);

      const [lat, lon, name] = geo;

      const url =
        `/route?start_lat=${currentStock.coords[0]}&start_lng=${currentStock.coords[1]}` +
        `&end_lat=${lat}&end_lng=${lon}`;

      const res = await fetch(url);
      if (!res.ok) return alert("Routing failed");

      const data = await res.json();
      if (!data.features) return alert("No route found");

      const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);
      const seg = data.features[0].properties.segments[0];

      const dist = (seg.distance / 1000).toFixed(2);
      const hrs = Math.floor(seg.duration / 3600);
      const mins = Math.round(((seg.duration / 3600) - hrs) * 60);
      const time = `${hrs}h ${mins}m`;

      const line = L.polyline(coords, { color:"blue", weight:3 }).addTo(map);

      const marker = L.marker([lat, lon], { icon: markerIcon("#007bff") })
        .addTo(map)
        .bindPopup(`<b>${name}</b><br>${dist} km<br>${time}`);

      deliveryLayers[uniqueKey] = { line, marker };

      /* TABLE ENTRY */
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${currentStock.name}</td>
        <td>${city}</td>
        <td>${dist} km</td>
        <td>${time}</td>
        <td>‚úî</td>
        <td><button class="remove-btn">√ó</button></td>`;
      deliveryTableBody.prepend(row);

      addedDeliveries.add(uniqueKey);

      /* ROUTE HIGHLIGHT */
      row.addEventListener("mouseenter", () => {
        line.setStyle({ color:"#000", weight:6 });

        if (marker._icon) {
          marker._icon.style.transform = "scale(1.4)";
          marker._icon.style.filter = "drop-shadow(0 0 10px rgba(0,0,0,0.8))";
        }

        if (stockMarker && stockMarker._icon) {
          stockMarker._icon.style.transform = "scale(1.4)";
          stockMarker._icon.style.filter = "drop-shadow(0 0 10px rgba(0,0,0,0.8))";
        }
      });

      row.addEventListener("mouseleave", () => {
        line.setStyle({ color:"blue", weight:3 });

        if (marker._icon) {
          marker._icon.style.transform = "scale(1)";
          marker._icon.style.filter = "";
        }

        if (stockMarker && stockMarker._icon) {
          stockMarker._icon.style.transform = "scale(1)";
          stockMarker._icon.style.filter = "";
        }
      });

      /* DELETE ROW */
      row.querySelector(".remove-btn").addEventListener("click", () => {
        map.removeLayer(line);
        map.removeLayer(marker);
        delete deliveryLayers[uniqueKey];
        addedDeliveries.delete(uniqueKey);
        row.remove();
      });
    }

    /*===================================
      MANUAL SEARCH ADD
    ===================================*/
    manualAddBtn.addEventListener("click", async () => {
      const city = manualInput.value.trim();
      if (!city) return alert("Enter a location");
      manualInput.value = "";
      await addDelivery(city);
    });

    // Enter key
    manualInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") manualAddBtn.click();
    });

    /*===================================
      LOADING OVERLAY CONTROL
    ===================================*/
    function showLoadingOverlay() {
      document.getElementById("loadingOverlay").style.display = "flex";
    }
    function hideLoadingOverlay() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    /*===================================
      PROCESS MULTIPLE DELIVERIES
    ===================================*/
    showDeliveriesBtn.addEventListener("click", async () => {
      const list = [...checkboxContainer.querySelectorAll("input[type='checkbox']:checked:not(#selectAll)")]
        .map(cb => cb.value);

      if (!list.length) return alert("Select at least one location");

      showLoadingOverlay();
      const loadingText = document.getElementById("loadingText");

      let seconds = 0;
      const timer = setInterval(() => {
        seconds++;
        loadingText.textContent = `Loading... ${seconds}s`;
      }, 1000);

      for (let i = 0; i < list.length; i++) {
        const percent = Math.round(((i + 1) / list.length) * 100);
        loadingText.textContent = `Loading ${i + 1} of ${list.length} (${percent}%) ‚Ä¢ ${seconds}s`;

        await addDelivery(list[i]);
      }

      clearInterval(timer);
      hideLoadingOverlay();

      successPopup.classList.add("show");
      setTimeout(() => successPopup.classList.remove("show"), 2000);
    });

    /*===================================
      CLEAR / RESET
    ===================================*/
    clearAllBtn.addEventListener("click", () => {
      Object.values(deliveryLayers).forEach(v => {
        map.removeLayer(v.line);
        map.removeLayer(v.marker);
      });

      deliveryLayers = {};
      addedDeliveries.clear();
      deliveryTableBody.innerHTML = "";
    });

    resetBtn.addEventListener("click", () => clearAllBtn.click());

    /*===================================
      TABS
    ===================================*/
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    /*===================================
      INIT
    ===================================*/
    populateLocations("North");
    loadRoutes();

  </script>

</body>
</html>
