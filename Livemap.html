<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HPCL Live Delivery Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body { margin:0; padding:0; height:100%; font-family:"Segoe UI",Roboto,sans-serif; }
    body { display:flex; background:#fff; overflow:hidden; }

    #sidebar {
      width:360px; background:#fff; border-right:1px solid #e0e0e0;
      padding:20px; box-shadow:4px 0 10px rgba(0,0,0,0.05);
      height:100vh; overflow-y:auto; display:flex; flex-direction:column; gap:14px;
    }
    #sidebar h2 { font-size:20px; font-weight:600; color:#004494; margin:0 0 4px; }

    label { font-size:13px; font-weight:600; margin-top:6px; display:block; }

    select, button {
      width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;
      background:#fff; font-size:14px; margin-top:6px;
    }

    button { background:#0056b3; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#00408a; }

    #map { flex:1; height:100vh; }

    .checkbox-group {
      border:1px solid #ddd; background:#f9fafb; padding:8px; border-radius:8px;
      max-height:150px; overflow-y:auto;
    }

    .tab-container { display:flex; gap:6px; }
    .tab { flex:1; padding:8px; text-align:center; border-radius:8px;
      background:#e9ecef; font-weight:600; cursor:pointer; }
    .tab.active { background:#0056b3; color:#fff; }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    table { width:100%; border-collapse:collapse; margin-top:8px; }
    th, td { padding:8px; border-bottom:1px solid #ddd; font-size:13px; }
    th { background:#f0f2f5; }

    .remove-btn {
      background:#e74c3c; color:#fff; border:none; padding:4px 8px;
      border-radius:4px; cursor:pointer;
    }

    #successPopup {
      position:fixed; top:50%; left:50%; padding:16px 26px;
      background:#e7f9ec; color:#256029; border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transform:translate(-50%, -50%) scale(0.8);
      opacity:0; pointer-events:none; transition:all .35s; z-index:9999;
      font-size:18px; font-weight:600;
    }
    #successPopup.show { opacity:1; transform:translate(-50%, -50%) scale(1); }
  </style>
</head>

<body>

  <div id="sidebar">
    <h2>HPCL Live Tracker</h2>
    <p><strong>Origin:</strong> Haldia Petrochemicals, WB</p>

    <div class="tab-container">
      <div class="tab active" data-tab="tracking">üì¶ Tracking</div>
      <div class="tab" data-tab="history">üìã Delivery History</div>
    </div>

    <div id="tracking" class="tab-content active">
      <label>Choose Stock Point:</label>
      <select id="stockSelect"></select>

      <label>Select Region:</label>
      <select id="regionSelect">
        <option value="North">North</option>
        <option value="West">West</option>
        <option value="East">East</option>
        <option value="South">South</option>
      </select>

      <label>Select Delivery Locations:</label>
      <div id="checkboxContainer" class="checkbox-group"></div>

      <button id="showDeliveriesBtn">üöõ Show Deliveries</button>
      <div id="railDistance">üìè Rail Route Distance: ‚Äî</div>
      <button id="resetBtn">üîÑ Reset Map</button>
    </div>

    <div id="history" class="tab-content">
      <table>
        <thead>
          <tr>
            <th>From</th><th>To</th><th>Distance</th>
            <th>Duration</th><th>Status</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="deliveryTableBody"></tbody>
      </table>
      <button id="clearAllBtn">üßπ Clear All</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="successPopup">‚úÖ Completed Successfully!</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    /* ===============================
       REGION-DELIVERY DEFINITIONS
    ================================ */
    const regionDeliveries = {
      North: ["Alwar","Bareilly City","Baddi","Chandigarh","Gurugram","Hapur","Haridwar","Hoshiarpur","Jalandhar","Jammu","Kanpur","Kashipur","Loni, Gaziabad","Lucknow","Saharanpur","Solan","Yamunanagar","Azadpur"],
      West: ["Ahmedabad","Ankleshwar","Dahej","Dombivli","Kandla, Gujarat","Khopoli","Lote","Mahad","Pune","Rajkot","Sabarkantha","Surat","Tarapur, Maharashtra","Vadodara","Valsad, Gujarat","Vapi, Gujarat"],
      East: [],
      South: []
    };

    /* ===============================
       MAP SETUP
    ================================ */
    const map = L.map("map").setView([20.5937, 78.9629], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    function markerIcon(color) {
      return L.divIcon({
        className: "custom-marker",
        html: `<div style="width:18px;height:18px;background:${color};border:2px solid #fff;border-radius:50%"></div>`,
        iconSize:[18,18], iconAnchor:[9,9]
      });
    }

    const origin = [22.0667, 88.1145];
    L.marker(origin, { icon: markerIcon("#d9534f") }).addTo(map)
      .bindPopup("Haldia Petrochemicals, WB");

    /* ===============================
       DOM ELEMENTS
    ================================ */
    const stockSelect = document.getElementById("stockSelect");
    const regionSelect = document.getElementById("regionSelect");
    const checkboxContainer = document.getElementById("checkboxContainer");
    const showDeliveriesBtn = document.getElementById("showDeliveriesBtn");
    const resetBtn = document.getElementById("resetBtn");
    const railDistanceDiv = document.getElementById("railDistance");
    const deliveryTableBody = document.getElementById("deliveryTableBody");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const successPopup = document.getElementById("successPopup");

    /* ===============================
       STATE
    ================================ */
    let stockData = {};
    let currentStock = null;
    let stockMarker = null;
    let railRouteLine = null;
    let deliveryLayers = {};

    /* ===============================
       LOAD STOCK POINT ROUTES
    ================================ */
    async function loadRoutes() {
      const res = await fetch("/routes");
      stockData = await res.json();

      stockSelect.innerHTML = "";
      Object.keys(stockData).forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = stockData[k].name;
        stockSelect.appendChild(opt);
      });

      const first = Object.keys(stockData)[0];
      if (first) setStockPoint(first);
    }

    /* ===============================
       SET STOCK POINT
    ================================ */
    function setStockPoint(key) {
      const stock = stockData[key];
      currentStock = stock;

      if (stockMarker) map.removeLayer(stockMarker);
      stockMarker = L.marker(stock.coords, { icon: markerIcon("#228B22") })
        .addTo(map)
        .bindPopup(stock.name);

      map.setView(stock.coords, 7);
      drawRailRoute(key);
    }

    stockSelect.addEventListener("change", e=> setStockPoint(e.target.value));

    /* ===============================
       DRAW RAIL ROUTE
    ================================ */
    function drawRailRoute(key) {
      if (railRouteLine) map.removeLayer(railRouteLine);

      const path = stockData[key].route;
      if (!path) return;

      let total = 0;
      for (let i = 1; i < path.length; i++) {
        total += map.distance(path[i-1], path[i]);
      }

      railDistanceDiv.innerHTML = `üìè Rail Route Distance: ${(total/1000).toFixed(1)} km`;
      railRouteLine = L.polyline(path, { color:"green", weight:3, dashArray:"5,5" }).addTo(map);
    }

    /* ===============================
       POPULATE REGION LOCATIONS
    ================================ */
    function populateLocations(region) {
      checkboxContainer.innerHTML = "";

      const all = document.createElement("label");
      all.innerHTML = `<input type="checkbox" id="selectAll"> Select All`;
      checkboxContainer.appendChild(all);

      regionDeliveries[region].forEach(city => {
        const lbl = document.createElement("label");
        lbl.innerHTML = `<input type="checkbox" value="${city}"> ${city}`;
        checkboxContainer.appendChild(lbl);
      });

      document.getElementById("selectAll").addEventListener("change", e => {
        checkboxContainer.querySelectorAll("input[type='checkbox']:not(#selectAll)")
          .forEach(cb => cb.checked = e.target.checked);
      });
    }

    regionSelect.addEventListener("change", e=> populateLocations(e.target.value));


    /* ===============================
       SECURE BACKEND GEOCODING (ORS)
    ================================ */
    async function geocodeORS(city) {
      const res = await fetch(`/geocode?query=${encodeURIComponent(city)}`);
      const data = await res.json();

      if (!data.features || !data.features.length) return null;

      const feat = data.features[0];
      const lon = feat.geometry.coordinates[0];
      const lat = feat.geometry.coordinates[1];
      const label = feat.properties.label || city;

      return [lat, lon, label];
    }

    /* ===============================
       ADD DELIVERY (ROUTING)
    ================================ */
    async function addDelivery(city) {
      const geo = await geocodeORS(city);
      if (!geo) { alert(`Failed geocoding ${city}`); return; }

      const [lat, lon, name] = geo;

      const url =
        `/route?start_lat=${currentStock.coords[0]}&start_lng=${currentStock.coords[1]}` +
        `&end_lat=${lat}&end_lng=${lon}`;

      const res = await fetch(url);
      if (!res.ok) { alert("Routing failed"); return; }

      const data = await res.json();
      if (!data.features) { alert("No route found"); return; }

      const coords = data.features[0].geometry.coordinates.map(c=>[c[1], c[0]]);
      const seg = data.features[0].properties.segments[0];

      const dist = (seg.distance/1000).toFixed(2);
      const hrs = Math.floor(seg.duration/3600);
      const mins = Math.round((seg.duration/3600 - hrs) * 60);
      const time = `${hrs}h ${mins}m`;

      const line = L.polyline(coords, { color:"blue", weight:3 }).addTo(map);
      const marker = L.marker([lat,lon], { icon: markerIcon("#007bff") })
        .addTo(map)
        .bindPopup(`<b>${name}</b><br>${dist} km<br>${time}`);

      deliveryLayers[city] = { line, marker };

      const row = document.createElement("tr");
      row.innerHTML =
        `<td>${currentStock.name}</td><td>${city}</td><td>${dist} km</td><td>${time}</td><td>‚úî</td>
         <td><button class="remove-btn">√ó</button></td>`;
      deliveryTableBody.prepend(row);

      row.querySelector(".remove-btn").addEventListener("click", () => {
        map.removeLayer(line);
        map.removeLayer(marker);
        delete deliveryLayers[city];
        row.remove();
      });
    }


    /* ===============================
       SHOW DELIVERIES
    ================================ */
    showDeliveriesBtn.addEventListener("click", async()=>{
      const list = [...checkboxContainer.querySelectorAll("input[type='checkbox']:checked:not(#selectAll)")].map(cb=>cb.value);
      if (!list.length) return alert("Select at least one location");

      for (let i=0; i<list.length; i++) {
        await addDelivery(list[i]);
      }

      successPopup.classList.add("show");
      setTimeout(()=> successPopup.classList.remove("show"),2000);
    });

    /* ===============================
       CLEAR + RESET
    ================================ */
    clearAllBtn.addEventListener("click", () => {
      Object.values(deliveryLayers).forEach(v=>{
        map.removeLayer(v.line);
        map.removeLayer(v.marker);
      });
      deliveryLayers = {};
      deliveryTableBody.innerHTML = "";
    });

    resetBtn.addEventListener("click", ()=> clearAllBtn.click());

    /* ===============================
       TABS
    ================================ */
    document.querySelectorAll(".tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".tab, .tab-content").forEach(el => el.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(tab.dataset.tab).classList.add("active");
      });
    });

    /* ===============================
       INIT
    ================================ */
    populateLocations("North");
    loadRoutes();
  </script>

</body>
</html>
